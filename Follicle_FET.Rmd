---
title: "HCG trigger of GnRHa-induced functional ovarian cysts"
author:
  - Hong Zeng 
documentclass: ctexart
keywords:
  - Gonadotrophin releasing hormone agonist
  - Functional ovarian cyst
  - Frozen-thawed embryo transfer
  - Hormone replacement therapy
geometry: "left=1.5cm, right=1.5cm, top=1.5cm, bottom=1.2cm"
output:
  rticles::ctex:
    fig_caption: yes
    number_sections: yes
    toc: yes
    toc_depth: 5
---
# first load the data
```{r}
# load data
load("Data.Rda")
```


# Statistical description of the crude cohort
```{r echo=TRUE, message=FALSE, warning=FALSE}
# install.packages("compareGroups") #if package "compareGroups" was not installed, then install the package.
library(compareGroups)
table1 <- descrTable(group ~ . - E2_trigger - Timing_downregulation - Timing_trigger - FollicularDiameter_trigger - Not_pregancny - BP- Male_factor -Other_factor- Ovulation_factor - DOR_factor - Tubal_factor - Combined_factor - PGT - Endometrial_abnormal - Scar_uterine - Uterine_malformation - endometritis, data=df, show.all=T,  method = c( bFSH=2), p.corrected = F, digits = 2)
table1
```


# Multivariate regression analysis revealed the risk factors associated with the incidence of functional ovarian cyst_age and BMI as continous vairables (model1)
```{r}
# install.packages("tidyverse") #if package "tidyverse" was not installed, then install the package.
# install.packages("geepack") #if package "geepack" was not installed, then install the package.
# install.packages("gtsummary") #if package "gtsummary" was not installed, then install the package.
library(tidyverse)
library(geepack)
library(gtsummary)
df <- within(df, {
  group_num <- NA
  group_num[group == "Control group"] <- "0"
  group_num[group == "Follicle group"] <- "1"
})
df$group_num <- as.numeric(df$group_num)
tbl_gee_FC1 <- geeglm(group_num ~ Age + BMI, id = ID, data = df, corstr="independence", family = binomial(logit)) %>% tbl_regression(exponentiate = TRUE)
tbl_gee_FC1
```


# Multivariate regression analysis revealed the risk factors associated with the incidence of functional ovarian cyst_age and BMI as categorical vairables (model2)
```{r}
library(tidyverse)
library(geepack)
library(gtsummary)
tbl_gee_FC2 <- geeglm(group_num ~ Cat_Age + Cat_BMI, id = ID, data = df, corstr="independence", family = binomial(logit)) %>% tbl_regression(exponentiate = TRUE)
tbl_gee_FC2
```

# Statistical description of the included cohort after excluding the cycles with exclusion criteria_before PSM
```{r echo=TRUE, message=FALSE, warning=FALSE}
table2 <- descrTable(group ~ . - E2_trigger - Timing_downregulation - Timing_trigger - FollicularDiameter_trigger - Not_pregancny - BP- Male_factor -Other_factor- Ovulation_factor - DOR_factor - Tubal_factor - Combined_factor - PGT - Endometrial_abnormal - Scar_uterine - Uterine_malformation - endometritis, data=df_select, show.all=T,  method = c( bFSH=2), p.corrected = F, digits = 2)
table2
```

# Calculate the implantation rate before PSM
```{r}
library(tidyverse)
IMR_beforePSM <- df_select %>% group_by(group) %>% summarise(total_sac=sum(No_sacs), total_ET=sum(No_ET_num), IMR=sum(No_sacs)/sum(No_ET_num)) 
IMR_beforePSM
chisq.test(as.matrix(IMR_beforePSM[,c("total_sac", "total_ET")]), correct = F)
```

# Multivariate regression analysis revealed the effect of HCG administration following GnRHa-induced functional ovarian cyst on clinical pregnancy in FET cycles

## Model1--adjusted for the number of transferred embryos, the number of transferred good-quality embryos, and the type of transferred embryos
```{r echo=TRUE, message=FALSE, warning=FALSE}
library(tidyverse)
library(geepack)
library(gtsummary)
tbl_gee_CP1 <- geeglm(CP_num ~ group + No_ET + No_GEm + Embryo_type, id = ID, data = df_select, corstr="independence", family = binomial(logit)) %>% tbl_regression(exponentiate = TRUE)
tbl_gee_CP1
```

## model2--adjusted for the number of transferred embryos, the number of transferred good-quality embryos, the type of transferred embryos, female age, and BMI
```{r echo=TRUE, message=FALSE, warning=FALSE}
library(tidyverse)
library(geepack)
library(gtsummary)
tbl_gee_CP2 <- geeglm(CP_num ~ group + Cat_Age + Cat_BMI + No_ET + No_GEm + Embryo_type, id = ID, data = df_select, corstr="independence", family = binomial(logit)) %>% tbl_regression(exponentiate = TRUE)
tbl_gee_CP2
```


## model3-adjusted with the number of transferred embryos, the number of transferred good-quality embryos, the type of transferred embryos, female age, BMI, endometrial thickness, and endometrial pattern,
```{r echo=TRUE, message=FALSE, warning=FALSE}
library(tidyverse)
library(geepack)
library(gtsummary)
tbl_gee_CP3 <- geeglm(CP_num ~ group + Cat_Age + Cat_BMI + No_ET + No_GEm + Embryo_type + Cat_EndoThickofET + Endometrial_pattern, id = ID, data = df_select, corstr="independence", family = binomial(logit)) %>% tbl_regression(exponentiate = TRUE)
tbl_gee_CP3
```

# propensity score mathcing(PSM)-1:1matching
```{r echo=TRUE, message=FALSE, warning=FALSE}
# install.packages("MatchIt") #install package "MatchIt" if the package was not installed
library(MatchIt)
set.seed(12345678)
matched_data1 <- MatchIt::matchit(group~Age + BMI + No_ET + No_GEm + Embryo_type, data=df_select, method = "nearest", ratio=1, caliper=0.02)
summary(matched_data1)
data_matched1 <- MatchIt::match.data(matched_data1)
plot(matched_data1, type = "jitter")
plot(matched_data1, type = "hist")   #draw histogram plot of scores before and after PSM
```

# Statistical description of the included cohort after excluding the cycles with exclusion criteria_after 1:1 PSM
```{r echo=TRUE, message=FALSE, warning=FALSE}
library(compareGroups)
table_match1 <- descrTable(group ~ . - E2_trigger - Timing_downregulation - Timing_trigger - FollicularDiameter_trigger - Not_pregancny - BP - Male_factor -Other_factor- Ovulation_factor - DOR_factor - Tubal_factor - Combined_factor - PGT - Endometrial_abnormal - Scar_uterine - Uterine_malformation - endometritis - CP_num -distance, data=data_matched1, show.all=T,  method = c( bFSH=2), p.corrected = F, digits = 2)
table_match1
```

# Calculate the implantation rate after PSM
```{r}
library(tidyverse)
IMR_afterPSM <- data_matched1 %>% group_by(group) %>% summarise(total_sac=sum(No_sacs), total_ET=sum(No_ET_num), IMR=sum(No_sacs)/sum(No_ET_num)) 
IMR_afterPSM
chisq.test(as.matrix(IMR_afterPSM[,c("total_sac", "total_ET")]), correct = F)
```
# The interactive analysis
```{r}
library(tidyverse)
library(geepack)
library(gtsummary)
gee_interactive <- geeglm(CP_num ~ group + Cat_Age + Cat_BMI + No_ET + No_GEm + Embryo_type + Cat_Age:group, data = df_select,family = binomial(logit), id = ID, corstr="independence")
summary(gee_interactive)
```

# Subgroup analysis based on age
## age >=35
```{r}
df_select_35 <- subset(df_select, Age>="35")
tbl_gee_CP_35 <- geeglm(CP_num ~ group + Cat_BMI + No_ET + No_GEm + Embryo_type, id = ID, data = df_select_35, corstr="independence", family = binomial(logit)) %>% tbl_regression(exponentiate = TRUE)
tbl_gee_CP_35
```

## age < 35
```{r}
df_select_35s <- subset(df_select, Age<"35")
tbl_gee_CP_35s <- geeglm(CP_num ~ group + Cat_BMI + No_ET + No_GEm + Embryo_type, id = ID, data = df_select_35s, corstr="independence", family = binomial(logit)) %>% tbl_regression(exponentiate = TRUE)
tbl_gee_CP_35s
```

